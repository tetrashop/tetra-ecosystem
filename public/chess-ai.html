<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø´Ø·Ø±Ù†Ø¬ Ù‡ÙˆØ´Ù…Ù†Ø¯ - Tetra Ecosystem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .chess-board {
            width: 400px;
            height: 400px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            border: 3px solid #8b4513;
            margin: 0 auto;
        }
        .chess-square {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .white {
            background-color: #f0d9b5;
        }
        .black {
            background-color: #b58863;
        }
        .selected {
            background-color: #aec6cf !important;
        }
        .possible-move {
            background-color: #90ee90 !important;
        }
        .chess-piece {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
        }
        .game-info {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
        }
        .difficulty-btn {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .difficulty-btn.active {
            border-color: #ffd700;
            background: #fff3cd;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="tetra-ecosystem.html">
                <i class="bi bi-plus-square"></i>
                Ø´Ø·Ø±Ù†Ø¬ Ù‡ÙˆØ´Ù…Ù†Ø¯
            </a>
            <div class="navbar-text">
                <span id="gameStatus">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø§Ø²ÛŒ</span>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row">
            <!-- ØµÙØ­Ù‡ Ø´Ø·Ø±Ù†Ø¬ -->
            <div class="col-md-6">
                <div class="card bg-secondary">
                    <div class="card-body text-center">
                        <div class="chess-board" id="chessBoard">
                            <!-- ØµÙØ­Ù‡ Ø´Ø·Ø±Ù†Ø¬ Ø¨Ø§ JavaScript Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-warning me-2" onclick="newGame()">
                                <i class="bi bi-plus-circle"></i>
                                Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
                            </button>
                            <button class="btn btn-info" onclick="undoMove()">
                                <i class="bi bi-arrow-counterclockwise"></i>
                                Ø¨Ø§Ø²Ú¯Ø´Øª Ø­Ø±Ú©Øª
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²ÛŒ -->
            <div class="col-md-6">
                <div class="game-info mb-4">
                    <h4 class="text-warning">â™Ÿï¸ Ø´Ø·Ø±Ù†Ø¬ Ù‡ÙˆØ´Ù…Ù†Ø¯ Tetra</h4>
                    <p>Ø­Ø±ÛŒÙ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø§ Ø³Ø·ÙˆØ­ Ù…Ø®ØªÙ„Ù Ø¯Ø´ÙˆØ§Ø±ÛŒ</p>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="h5 text-success" id="playerScore">Û°</div>
                            <small>Ø¨Ø±Ø¯ Ø´Ù…Ø§</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-warning" id="drawCount">Û°</div>
                            <small>Ù…Ø³Ø§ÙˆÛŒ</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-danger" id="aiScore">Û°</div>
                            <small>Ø¨Ø±Ø¯ AI</small>
                        </div>
                    </div>
                </div>

                <!-- Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ -->
                <div class="card bg-dark mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ¯ Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ</h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-success difficulty-btn active" data-level="1">
                                Ù…Ø¨ØªØ¯ÛŒ
                            </button>
                            <button class="btn btn-outline-warning difficulty-btn" data-level="2">
                                Ù…ØªÙˆØ³Ø·
                            </button>
                            <button class="btn btn-outline-danger difficulty-btn" data-level="3">
                                Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø­Ø±Ú©Ø§Øª -->
                <div class="card bg-dark">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“œ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø­Ø±Ú©Ø§Øª</h5>
                    </div>
                    <div class="card-body">
                        <div id="moveHistory" style="max-height: 200px; overflow-y: auto;">
                            <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø­Ø±Ú©Ø§Øª -->
                        </div>
                    </div>
                </div>

                <!-- Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²ÛŒ -->
                <div class="card bg-dark mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“Š Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²ÛŒ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <small>Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒ</small>
                                <div class="text-info" id="gameTime">Û°Û°:Û°Û°</div>
                            </div>
                            <div class="col-6">
                                <small>ØªØ¹Ø¯Ø§Ø¯ Ø­Ø±Ú©Ø§Øª</small>
                                <div class="text-warning" id="moveCount">Û°</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5>ğŸ† Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ELO</h5>
                        <p>Ø¯Ø±Ø¬Ù‡ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§: <span id="playerRating" class="h4">Û±Û²Û°Û°</span></p>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-warning" style="width: 60%">Û¶Û°Ùª Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ</div>
                        </div>
                        <small>Ø¨Ø§ Ù‡Ø± Ø¨Ø±Ø¯ Û±Û° Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø¨Ø§ Ù‡Ø± Ø¨Ø§Ø®Øª Ûµ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="data-manager.js"></script>
    <script>
        class ChessAI {
            constructor(difficulty = 1) {
                this.difficulty = difficulty;
                this.board = this.createInitialBoard();
                this.currentPlayer = 'white';
                this.selectedPiece = null;
                this.moveHistory = [];
                this.gameActive = true;
            }

            createInitialBoard() {
                // Ø§ÛŒØ¬Ø§Ø¯ ØµÙØ­Ù‡ Ø´Ø·Ø±Ù†Ø¬ Ø§ÙˆÙ„ÛŒÙ‡
                const board = Array(8).fill().map(() => Array(8).fill(null));
                
                // Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ§Ù‡
                board[0] = ['â™œ', 'â™', 'â™', 'â™›', 'â™š', 'â™', 'â™', 'â™œ'];
                board[1] = Array(8).fill('â™Ÿ');
                
                // Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙÛŒØ¯
                board[6] = Array(8).fill('â™™');
                board[7] = ['â™–', 'â™˜', 'â™—', 'â™•', 'â™”', 'â™—', 'â™˜', 'â™–'];
                
                return board;
            }

            getPossibleMoves(row, col) {
                const piece = this.board[row][col];
                if (!piece) return [];

                const moves = [];
                const pieceType = this.getPieceType(piece);

                // Ù…Ù†Ø·Ù‚ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Ø§Øª (Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡â€ŒØªØ± Ø§Ø³Øª)
                switch(pieceType) {
                    case 'pawn':
                        // Ø³Ø±Ø¨Ø§Ø²
                        const direction = this.currentPlayer === 'white' ? -1 : 1;
                        if (this.isValidMove(row + direction, col) && !this.board[row + direction][col]) {
                            moves.push([row + direction, col]);
                        }
                        break;
                    case 'rook':
                        // Ø±Ø®
                        for (let i = -1; i <= 1; i += 2) {
                            for (let j = -1; j <= 1; j += 2) {
                                let r = row + i, c = col + j;
                                while (this.isValidMove(r, c) && !this.board[r][c]) {
                                    moves.push([r, c]);
                                    r += i;
                                    c += j;
                                }
                            }
                        }
                        break;
                    // Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§ Ù†ÛŒØ² Ù…Ù†Ø·Ù‚ Ù…Ø´Ø§Ø¨Ù‡
                }

                return moves;
            }

            getPieceType(piece) {
                const blackPieces = {'â™Ÿ': 'pawn', 'â™œ': 'rook', 'â™': 'knight', 'â™': 'bishop', 'â™›': 'queen', 'â™š': 'king'};
                const whitePieces = {'â™™': 'pawn', 'â™–': 'rook', 'â™˜': 'knight', 'â™—': 'bishop', 'â™•': 'queen', 'â™”': 'king'};
                return blackPieces[piece] || whitePieces[piece];
            }

            isValidMove(row, col) {
                return row >= 0 && row < 8 && col >= 0 && col < 8;
            }

            makeMove(fromRow, fromCol, toRow, toCol) {
                if (!this.gameActive) return false;

                const piece = this.board[fromRow][fromCol];
                if (!piece) return false;

                // Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¨Øª
                const isWhitePiece = 'â™™â™–â™˜â™—â™•â™”'.includes(piece);
                if ((this.currentPlayer === 'white' && !isWhitePiece) || 
                    (this.currentPlayer === 'black' && isWhitePiece)) {
                    return false;
                }

                // Ø§Ù†Ø¬Ø§Ù… Ø­Ø±Ú©Øª
                this.board[toRow][toCol] = piece;
                this.board[fromRow][fromCol] = null;

                // Ø«Ø¨Øª ØªØ§Ø±ÛŒØ®Ú†Ù‡
                this.moveHistory.push({
                    from: [fromRow, fromCol],
                    to: [toRow, toCol],
                    piece: piece,
                    player: this.currentPlayer
                });

                // ØªØºÛŒÛŒØ± Ù†ÙˆØ¨Øª
                this.currentPlayer = this.currentPlayer === 'white' ? 'black' : 'white';

                return true;
            }

            aiMove() {
                if (this.currentPlayer !== 'black' || !this.gameActive) return;

                setTimeout(() => {
                    // AI Ø­Ø±Ú©Øª Ø³Ø§Ø¯Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ (Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡â€ŒØªØ±)
                    const possibleMoves = [];
                    
                    for (let row = 0; row < 8; row++) {
                        for (let col = 0; col < 8; col++) {
                            const piece = this.board[row][col];
                            if (piece && 'â™Ÿâ™œâ™â™â™›â™š'.includes(piece)) {
                                const moves = this.getPossibleMoves(row, col);
                                moves.forEach(move => {
                                    possibleMoves.push({from: [row, col], to: move});
                                });
                            }
                        }
                    }

                    if (possibleMoves.length > 0) {
                        const randomMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                        this.makeMove(...randomMove.from, ...randomMove.to);
                        updateBoard();
                        checkGameStatus();
                    }
                }, 1000);
            }
        }

        let chessGame;
        let gameStats = {
            wins: 0,
            losses: 0,
            draws: 0,
            rating: 1200,
            startTime: null
        };

        function initGame() {
            chessGame = new ChessAI();
            gameStats.startTime = new Date();
            updateBoard();
            updateMoveHistory();
            updateGameStats();
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ø§Ø² localStorage
            const savedStats = localStorage.getItem('chessStats');
            if (savedStats) {
                gameStats = {...gameStats, ...JSON.parse(savedStats)};
                updateGameStats();
            }

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    chessGame.difficulty = parseInt(this.dataset.level);
                });
            });
        }

        function updateBoard() {
            const board = document.getElementById('chessBoard');
            board.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = `chess-square ${(row + col) % 2 === 0 ? 'white' : 'black'}`;
                    square.dataset.row = row;
                    square.dataset.col = col;

                    const piece = chessGame.board[row][col];
                    if (piece) {
                        const pieceElement = document.createElement('div');
                        pieceElement.className = 'chess-piece';
                        pieceElement.textContent = piece;
                        pieceElement.addEventListener('click', () => selectPiece(row, col));
                        square.appendChild(pieceElement);
                    } else {
                        square.addEventListener('click', () => movePiece(row, col));
                    }

                    board.appendChild(square);
                }
            }
        }

        function selectPiece(row, col) {
            const piece = chessGame.board[row][col];
            if (!piece) return;

            // ÙÙ‚Ø· Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙÛŒØ¯ (Ú©Ø§Ø±Ø¨Ø±) Ù‚Ø§Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ø³ØªÙ†Ø¯
            if (!'â™™â™–â™˜â™—â™•â™”'.includes(piece)) return;

            // Ø­Ø°Ù Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø¨Ù„ÛŒ
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.possible-move').forEach(el => el.classList.remove('possible-move'));

            // Ø§Ù†ØªØ®Ø§Ø¨ Ø¬Ø¯ÛŒØ¯
            const square = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            square.classList.add('selected');
            chessGame.selectedPiece = {row, col};

            // Ù†Ù…Ø§ÛŒØ´ Ø­Ø±Ú©Ø§Øª Ù…Ù…Ú©Ù†
            const moves = chessGame.getPossibleMoves(row, col);
            moves.forEach(([moveRow, moveCol]) => {
                const moveSquare = document.querySelector(`[data-row="${moveRow}"][data-col="${moveCol}"]`);
                if (moveSquare) moveSquare.classList.add('possible-move');
            });
        }

        function movePiece(toRow, toCol) {
            if (!chessGame.selectedPiece) return;

            const fromRow = chessGame.selectedPiece.row;
            const fromCol = chessGame.selectedPiece.col;
            
            if (chessGame.makeMove(fromRow, fromCol, toRow, toCol)) {
                updateBoard();
                updateMoveHistory();
                chessGame.selectedPiece = null;

                // Ø­Ø±Ú©Øª AI
                setTimeout(() => {
                    chessGame.aiMove();
                    updateGameTime();
                }, 500);
            }
        }

        function updateMoveHistory() {
            const historyDiv = document.getElementById('moveHistory');
            historyDiv.innerHTML = chessGame.moveHistory.map((move, index) => `
                <div class="border-bottom pb-1 mb-1">
                    <small>Ø­Ø±Ú©Øª ${index + 1}: ${move.piece} Ø§Ø² ${move.from} Ø¨Ù‡ ${move.to}</small>
                </div>
            `).join('');

            document.getElementById('moveCount').textContent = chessGame.moveHistory.length;
        }

        function updateGameStats() {
            document.getElementById('playerScore').textContent = gameStats.wins;
            document.getElementById('aiScore').textContent = gameStats.losses;
            document.getElementById('drawCount').textContent = gameStats.draws;
            document.getElementById('playerRating').textContent = gameStats.rating;
        }

        function updateGameTime() {
            if (!gameStats.startTime) return;
            const now = new Date();
            const diff = Math.floor((now - gameStats.startTime) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            document.getElementById('gameTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkGameStatus() {
            // Ù…Ù†Ø·Ù‚ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
            // Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ù…Ù„â€ŒØªØ± Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯
        }

        function newGame() {
            chessGame = new ChessAI();
            gameStats.startTime = new Date();
            updateBoard();
            updateMoveHistory();
            document.getElementById('gameStatus').textContent = 'Ø¨Ø§Ø²ÛŒ ÙØ¹Ø§Ù„';
            document.getElementById('gameTime').textContent = 'Û°Û°:Û°Û°';
            document.getElementById('moveCount').textContent = 'Û°';
        }

        function undoMove() {
            if (chessGame.moveHistory.length > 0) {
                chessGame.moveHistory.pop();
                // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ (Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ù…Ù„â€ŒØªØ±)
                updateBoard();
                updateMoveHistory();
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', initGame);

        // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ù…Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('chessStats', JSON.stringify(gameStats));
        });
    </script>
</body>
</html>
